<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width initial-scale=1" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>Advanced Varnish configuration | Magento 2 Developer Documentation</title>
	<meta name="description" content="Magento 2 Developer Documentation.
">

	<link rel="stylesheet" href="/assets/css/app.css" />
	<link rel="stylesheet" href="/assets/css/print.css" media="print"/>

	<link rel="stylesheet" href="/common/css/devdocs.css" />

	<script>
  var baseUrl = "";
  var algolia = {
    id : "E642SEDTHL",
    index:  "devdocs",
    key:  "d2d0f33ab73e291ef8d88d8b565e754c"
  };
</script>



<!-- Google Analytics -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-66243208-1', 'auto');
    ga('send', 'pageview');
</script>

<!-- Hotjar Tracking Code for http://devdocs.magento.com/ -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:806243,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

<!-- heap analytics -->
<script type="text/javascript">
      window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
      heap.load("2619540280");
</script>




	<link rel="canonical" href="/guides/v2.3/config-guide/varnish/config-varnish-advanced.html">

	<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="https://magento.com/favicon.ico">
	<link rel="apple-touch-icon" type="image/png" href="https://magento.com/apple-touch-icon.png">
	<link rel="apple-touch-icon" type="image/png" sizes="57x57" href="https://magento.com/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" type="image/png" sizes="72x72" href="https://magento.com/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://magento.com/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" type="image/png" sizes="114x114" href="https://magento.com/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://magento.com/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="https://magento.com/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://magento.com/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://magento.com/apple-touch-icon-180x180.png">

</head>
<body class="layout-default">

	<header class="site-header">

		<nav class="site-nav">

  <div class="menu-btn">
    <a id="menu-btn" class="menu-trigger menu-icon" href="#nav-main" aria-haspopup="true" aria-controls="nav-main"></a>
  </div>

  <div class="nav-container">

    <a class="logo" href="/guides/v2.3/">
      <img src="/assets/i/m-logo.svg" alt=""><img src="/assets/i/magento-logo.svg" alt="Magento" class="magento-logo" />
      <span class="site-logo">DevDocs</span>
    </a>

    <div id="nav-main" class="nav-main-wrap" aria-labelledby="menu-btn">
      
<div class="version-switcher dropdown" data-version="2.3">
	<button id="version-switcher-button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Magento 2.3 Pre-release
	</button>

	<ul class="dropdown-menu dropdown-menu-left" aria-labelledby="version-switcher-button">
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.0/config-guide/varnish/config-varnish-advanced.html">Magento 2.0</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.1/config-guide/varnish/config-varnish-advanced.html">Magento 2.1</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.2/config-guide/varnish/config-varnish-advanced.html">Magento 2.2</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.3/config-guide/varnish/config-varnish-advanced.html">Magento 2.3 Pre-release</a></li>
	
  </ul>

</div>


      <!-- Main Navigation -->
<ul class="nav-main" role="menubar">

  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Setup</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          <li><a href="/guides/v2.3/install-gde/bk-install-guide.html">Installation Guide</a></li>
          
          <li><a href="/guides/v2.3/config-guide/bk-config-guide.html">Configuration Guide</a></li>
          
          <li><a href="/guides/v2.3/performance-best-practices/index.html">Performance Best Practices</a></li>
          
          <li><a href="/guides/v2.3/migration/bk-migration-guide.html">Migration Guide</a></li>
          <li><a href="/guides/v2.3/cloud/bk-cloud.html">Magento Commerce (Cloud) Guide</a></li>
          <li><a href="/magento-release-information.html">Release Information</a></li>
      </ul>
    </div>

  </li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Development</span>

    <div class="nav-popup" role="menu" aria-hidden="true">

      <div class="nav-section">
        <div class="nav-section-title">Backend</div>
        <ul>
          <li><a href="/guides/v2.3/architecture/bk-architecture.html">Architecture Guide</a></li>
          <li><a href="/guides/v2.3/extension-dev-guide/bk-extension-dev-guide.html">PHP Developer Guide</a></li>
          <li><a href="/guides/v2.3/ext-best-practices/bk-ext-best-practices.html">Extension Developer Best Practices</a></li>
          <li><a href="/guides/v2.3/mrg/intro.html">Module Reference Guide</a></li>
          <li><a href="/guides/v2.3/coding-standards/bk-coding-standards.html">Coding Standards</a></li>
          <li><a href="/guides/v2.3/contributor-guide/contributing.html">Contributor Guide</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Frontend</div>
        <ul>
          <li class=""><a href="/guides/v2.3/frontend-dev-guide/bk-frontend-dev-guide.html">Frontend Developer Guide</a></li>
          
          <li><a href="/guides/v2.3/ui_comp_guide/bk-ui_comps.html">UI Components Guide</a></li>
          
          <li><a href="/guides/v2.3/javascript-dev-guide/bk-javascript-dev-guide.html">JavaScript Developer Guide</a></li>
          <li><a href="/guides/v2.3/pattern-library/bk-pattern.html">Admin Design Pattern Library</a></li>
          <li><a href="/guides/v2.3/design-styleguide/bk-styleguide.html">Admin Style Guide</a></li>
          <li><a href="https://magento-research.github.io/pwa-devdocs/">PWA Studios</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title"><abbr>API</abbr></div>
        <ul>
          <li><a href="/guides/v2.3/get-started/bk-get-started-api.html">Get Started with Magento Web APIs</a></li>
          <li><a href="/guides/v2.3/rest/bk-rest.html">REST API Reference</a></li>
          <li><a href="/guides/v2.3/soap/bk-soap.html">SOAP API Reference</a></li>
          
          <li><a href="/guides/v2.3/graphql/index.html">GraphQL Developer Guide (New!)</a></li>
          
          
          <li><a href="/guides/v2.3/marketplace/eqp/api.html">Marketplace EQP API Reference</a></li>
          
        </ul>
      </div>
    </div>

  </li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Testing</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.3/test/testing.html">Magento Testing Guide</a></li>
        
        <li><a href="/guides/v2.3/magento-functional-testing-framework/release-2/introduction.html">Functional Acceptance Testing (New!)</a></li>
        
        <li><a href="/guides/v2.3/mtf/mtf_introduction.html">Functional Testing</a></li>
        <li><a href="/guides/v2.3/test/integration/integration_test_execution.html">Integration Testing</a></li>
        <li><a href="/guides/v2.3/test/js/jasmine.html">JavaScript Unit Testing</a></li>
        <li><a href="/guides/v2.3/test/unit/unit_test_execution.html">PHP Unit Testing</a></li>
        <li><a href="/guides/v2.3/get-started/web-api-functional-testing.html">Web API Functional Testing</a></li>
      </ul>
    </div>

  </li>


  <li class="nav-main-separator"></li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Functional Areas</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          
          <li class="leaf"><a href="/guides/v2.3/advanced-reporting/overview.html">Advanced Reporting</a></li>
          
        
        <li class="leaf"><a href="/guides/v2.3/b2b/bk-b2b.html">B2B</a></li>
        
        <li><a href="/guides/v2.3/howdoi/checkout/checkout_overview.html">Checkout</a></li>
        <li><a href="/guides/v2.3/payments-integrations/bk-payments-integrations.html">Payment Integrations</a></li>
        
          <li><a href="/guides/v2.3/extension-dev-guide/staging.html">Staging</a></li>
        
      </ul>
    </div>

  </li>


  <li class="nav-main-item"  tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Tutorials</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.3/howdoi/bk-how-do-i.html">How To</a></li>
        
        <li><a  data-proofer-ignore href="/guides/v2.3/get-started/order-tutorial/order-intro.html">Order Processing with REST APIs</a></li>
        

        <li><a href="/videos/">Video Tutorials</a></li>
      </ul>
    </div>

  </li>

</ul><!-- /.nav-main -->

    </div>

    <div class="search-btn">
      <a class="search-trigger search-icon" href="#"></a>
    </div>

    <form class="quick-search" action="/guides/v2.3/search.html" method="get" novalidate="novalidate">
      <input type="search" name="q" placeholder="Search" />
      <a href="#" class="quick-search-close">&times;</a>
    </form>

  </div>

</nav><!-- #site-nav -->
<div class="nav-main-fader"></div>


	</header>

	<div class="global-wrapper">

		<div class="main-container">
			<a id="main-content"></a>


<div class="content-container">

    
    <div class="message-banner">
        This is the 2.3 Alpha release version of Magento documentation. Content in this version is subject to change.
    </div>
    

	<!-- sidebar -->
<aside class="sidebar">
	<a href="#" data-proofer-ignore class="toc-toggler">Table of Contents</a>
	<div class="sidebar-wrapper">

		

		<h4 class="guide-title">Configuration Guide</h4>
		<div class="collapsible-navigation">
		    <ul>
		    
		    	

<li class="nav-level1  " id="introduction">
    

    
    <a href="/guides/v2.3/config-guide/bk-config-guide.html">Introduction</a>
    

    
</li>


		    
		    	

<li class="nav-level1  " id="security-settings">
    

    
    <a href="/guides/v2.3/config-guide/secy/secy.html">Security settings</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="secure-cron.php-to-run-in-a-browser">

            

            
            <a href="/guides/v2.3/config-guide/secy/secy-cron.html">Secure cron.php to run in a browser</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="x-frame-options-header">

            

            
            <a href="/guides/v2.3/config-guide/secy/secy-xframe.html">X-Frame-Options header</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="prevent-cache-poisoning">

            

            
            <a href="/guides/v2.3/config-guide/secy/secy-headers.html">Prevent cache poisoning</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="magento-application-initialization-and-bootstrap">
    

    
    <a href="/guides/v2.3/config-guide/bootstrap/magento-bootstrap.html">Magento application initialization and bootstrap</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="set-the-value-of-bootstrap-parameters">

            

            
            <a href="/guides/v2.3/config-guide/bootstrap/magento-how-to-set.html">Set the value of bootstrap parameters</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="about-magento-modes">

            

            
            <a href="/guides/v2.3/config-guide/bootstrap/magento-modes.html">About Magento modes</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="customize-base-directory-paths-(mage_dirs)">

            

            
            <a href="/guides/v2.3/config-guide/bootstrap/mage-dirs.html">Customize base directory paths (MAGE_DIRS)</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="enable-profiling-(mage_profiler)">

            

            
            <a href="/guides/v2.3/config-guide/bootstrap/mage-profiler.html">Enable profiling (MAGE_PROFILER)</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="pipeline-deployment">
    

    
    <a href="/guides/v2.3/config-guide/deployment/">Pipeline Deployment</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="overview">

            

            
            <a href="/guides/v2.3/config-guide/deployment/pipeline/">Overview</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="technical-details">

            

            
            <a href="/guides/v2.3/config-guide/deployment/pipeline/technical-details.html">Technical Details</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="development-system-setup">

            

            
            <a href="/guides/v2.3/config-guide/deployment/pipeline/development-system.html">Development System Setup</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="build-system-setup">

            

            
            <a href="/guides/v2.3/config-guide/deployment/pipeline/build-system.html">Build System Setup</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="production-system-setup">

            

            
            <a href="/guides/v2.3/config-guide/deployment/pipeline/production-system.html">Production System Setup</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="file-systems-access-permissions">

            

            
            <a href="/guides/v2.3/config-guide/prod/prod_file-sys-perms.html">File systems access permissions</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="examples">

            

            
            <span>Examples</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="shared-configuration">
                    

                    
                    <a  href="/guides/v2.3/config-guide/deployment/pipeline/example/shared-configuration.html">Shared configuration</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="using-cli-commands">
                    

                    
                    <a  href="/guides/v2.3/config-guide/deployment/pipeline/example/cli.html">Using CLI commands</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="using-environment-variables">
                    

                    
                    <a  href="/guides/v2.3/config-guide/deployment/pipeline/example/environment-variables.html">Using environment variables</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="using-rsync">
                    

                    
                    <a  href="/guides/v2.3/config-guide/deployment/pipeline/example/rsync.html">Using rsync</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="single-machine-deployment">
    

    
    <a href="/guides/v2.3/config-guide/deployment/single-machine.html">Single machine deployment</a>
    

    
</li>


		    
		    	

<li class="nav-level1  " id="command-line-configuration">
    

    
    <a href="/guides/v2.3/config-guide/cli/config-cli.html">Command line configuration</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="get-started-with-command-line-configuration">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands.html">Get started with command-line configuration</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="manage-the-cache">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-cache.html">Manage the cache</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="manage-the-indexers">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-index.html">Manage the indexers</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-and-run-cron">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-cron.html">Configure and run cron</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="code-compiler">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-compiler.html">Code compiler</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-the-magento-mode">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-mode.html">Set the Magento mode</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="urn-highlighter">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-urn.html">URN highlighter</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="dependency-reports">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-depen.html">Dependency reports</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configuration-management">

            

            
            <span>Configuration management</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="export-the-configuration">
                    

                    
                    <a  href="/guides/v2.3/config-guide/cli/config-cli-subcommands-config-mgmt-export.html">Export the configuration</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="set-configuration-values">
                    

                    
                    <a  href="/guides/v2.3/config-guide/cli/config-cli-subcommands-config-mgmt-set.html">Set configuration values</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="import-data-from-configuration-files">
                    

                    
                    <a  href="/guides/v2.3/config-guide/cli/config-cli-subcommands-config-mgmt-import.html">Import data from configuration files</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
        
        
        <li class="nav-level2  " id="translation-dictionaries-and-language-packages">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-i18n.html">Translation dictionaries and language packages</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="static-view-files-deployment">

            

            
            <span>Static view files deployment</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="static-files-deployment-strategies">
                    

                    
                    <a  href="/guides/v2.3/config-guide/cli/config-cli-subcommands-static-deploy-strategies.html">Static files deployment strategies</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="deploy-static-view-files">
                    

                    
                    <a  href="/guides/v2.3/config-guide/cli/config-cli-subcommands-static-view.html">Deploy static view files</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
        
        
        <li class="nav-level2  " id="create-symlinks-to-less-files">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-less-sass.html">Create symlinks to LESS files</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="run-unit-tests">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-test.html">Run unit tests</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="convert-layout-xml-files">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-layout-xml.html">Convert layout XML files</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="generate-data-for-performance-testing">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-perf-data.html">Generate data for performance testing</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="run-the-support-utilities-(magento-commerce-only)">

            

            
            <a href="/guides/v2.3/config-guide/cli/config-cli-subcommands-spt-util.html">Run the support utilities (Magento Commerce only)</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="magento-configuration-files">
    

    
    <a href="/guides/v2.3/config-guide/config/config-magento.html">Magento configuration files</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="magento's-deployment-configuration">

            

            
            <a href="/guides/v2.3/config-guide/config/config-php.html">Magento's deployment configuration</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="module-configuration-files">

            

            
            <a href="/guides/v2.3/config-guide/config/config-files.html">Module configuration files</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="create-or-extend-configuration-types">

            

            
            <a href="/guides/v2.3/config-guide/config/config-create.html">Create or extend configuration types</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="disable-module-output">

            

            
            <a href="/guides/v2.3/config-guide/config/disable-module-output.html">Disable module output</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configuration-reference">

            

            
            <span>Configuration reference</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="sensitive-and-system-specific">
                    

                    
                    <a  href="/guides/v2.3/config-guide/prod/config-reference-sens.html">Sensitive and system-specific</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="payment-configuration-paths-reference">
                    

                    
                    <a  href="/guides/v2.3/config-guide/prod/config-reference-payment.html">Payment configuration paths reference</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="other-configuration-paths-reference">
                    

                    
                    <a  href="/guides/v2.3/config-guide/prod/config-reference-most.html">Other configuration paths reference</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="magento-commerce-for-b2b-extension-configuration-paths-reference">
                    

                    
                    <a  href="/guides/v2.3/config-guide/prod/config-reference-b2b.html">Magento Commerce for B2B Extension configuration paths reference</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id=".gitignore-reference">
                    

                    
                    <a  href="/guides/v2.3/config-guide/prod/config-reference-gitignore.html">.gitignore reference</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="use-environment-variables-to-override-configuration-settings">
                    

                    
                    <a  href="/guides/v2.3/config-guide/prod/config-reference-var-name.html">Use environment variables to override configuration settings</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="config.php-reference">
                    

                    
                    <a  href="/guides/v2.3/config-guide/prod/config-reference-configphp.html">config.php reference</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="env.php-reference">
                    

                    
                    <a  href="/guides/v2.3/config-guide/prod/config-reference-envphp.html">env.php reference</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="configure-caching">
    

    
    <a href="/guides/v2.3/config-guide/cache.html">Configure caching</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="associate-cache-frontends-with-cache-types">

            

            
            <a href="/guides/v2.3/config-guide/cache/cache-types.html">Associate cache frontends with cache types</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="low-level-cache-options">

            

            
            <a href="/guides/v2.3/config-guide/cache/cache-options.html">Low-level cache options</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="static-content-signing">

            

            
            <a href="/guides/v2.3/config-guide/cache/static-content-signing.html">Static content signing</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="configure-redis">
    

    
    <a href="/guides/v2.3/config-guide/redis/config-redis.html">Configure Redis</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="use-redis-for-the-magento-page-and-default-cache">

            

            
            <a href="/guides/v2.3/config-guide/redis/redis-pg-cache.html">Use Redis for the Magento page and default cache</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="use-redis-for-session-storage">

            

            
            <a href="/guides/v2.3/config-guide/redis/redis-session.html">Use Redis for session storage</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="configure-and-use-varnish">
    

    
    <a href="/guides/v2.3/config-guide/varnish/config-varnish.html">Configure and use Varnish</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="install-varnish">

            

            
            <a href="/guides/v2.3/config-guide/varnish/config-varnish-install.html">Install Varnish</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-varnish-and-your-web-server">

            

            
            <a href="/guides/v2.3/config-guide/varnish/config-varnish-configure.html">Configure Varnish and your web server</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-magento-to-use-varnish">

            

            
            <a href="/guides/v2.3/config-guide/varnish/config-varnish-magento.html">Configure Magento to use Varnish</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2 active " id="advanced-varnish-configuration">

            

            
            <a href="/guides/v2.3/config-guide/varnish/config-varnish-advanced.html">Advanced Varnish configuration</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="how-magento-cache-clearing-works-with-multiple-varnish-instances">

            

            
            <a href="/guides/v2.3/config-guide/varnish/use-multiple-varnish-cache.html">How Magento cache clearing works with multiple Varnish instances</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="final-verification">

            

            
            <a href="/guides/v2.3/config-guide/varnish/config-varnish-final.html">Final verification</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="how-magento-cache-clearing-works-with-varnish">

            

            
            <a href="/guides/v2.3/config-guide/varnish/use-varnish-cache.html">How Magento cache clearing works with Varnish</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="how-varnish-caching-works">

            

            
            <a href="/guides/v2.3/config-guide/varnish/use-varnish-cache-how.html">How Varnish caching works</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="troubleshooting-503-errors">

            

            
            <a href="/guides/v2.3/config-guide/varnish/tshoot-varnish-503.html">Troubleshooting 503 errors</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="use-memcached-for-session-storage">
    

    
    <a href="/guides/v2.3/config-guide/memcache/memcache.html">Use memcached for session storage</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="install,-configure,-verify-memcached-on-ubuntu">

            

            
            <a href="/guides/v2.3/config-guide/memcache/memcache_ubuntu.html">Install, configure, verify memcached on Ubuntu</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install,-configure,-verify-memcached-on-centos">

            

            
            <a href="/guides/v2.3/config-guide/memcache/memcache_centos.html">Install, configure, verify memcached on CentOS</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-magento-to-use-memcached">

            

            
            <a href="/guides/v2.3/config-guide/memcache/memcache_magento.html">Configure Magento to use memcached</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="multiple-websites-or-stores">
    

    
    <a href="/guides/v2.3/config-guide/multi-site/ms_over.html">Multiple websites or stores</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="set-up-multiple-websites,-stores,-and-store-views-in-the-admin">

            

            
            <a href="/guides/v2.3/config-guide/multi-site/ms_websites.html">Set up multiple websites, stores, and store views in the Admin</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="tutorial—set-up-multiple-websites-or-stores-with-nginx">

            

            
            <a href="/guides/v2.3/config-guide/multi-site/ms_nginx.html">Tutorial—Set up multiple websites or stores with nginx</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="tutorial—set-up-multiple-websites-with-apache">

            

            
            <a href="/guides/v2.3/config-guide/multi-site/ms_apache.html">Tutorial—Set up multiple websites with Apache</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="set-up-a-custom-cron-job-and-cron-group">
    

    
    <a href="/guides/v2.3/config-guide/cron/custom-cron.html">Set up a custom cron job and cron group</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="custom-cron-job-and-cron-group-reference">

            

            
            <a href="/guides/v2.3/config-guide/cron/custom-cron-ref.html">Custom cron job and cron group reference</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-a-custom-cron-job-and-cron-group-(tutorial)">

            

            
            <a href="/guides/v2.3/config-guide/cron/custom-cron-tut.html">Configure a custom cron job and cron group (tutorial)</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="configure-the-database-profiler">
    

    
    <a href="/guides/v2.3/config-guide/db-profiler/db-profiler.html">Configure the database profiler</a>
    

    
</li>


		    
		    	

		    
		    	

<li class="nav-level1  " id="install-and-configure-elasticsearch">
    

    
    <a href="/guides/v2.3/config-guide/elasticsearch/es-overview.html">Install and configure Elasticsearch</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="configure-nginx-and-elasticsearch">

            

            
            <a href="/guides/v2.3/config-guide/elasticsearch/es-config-nginx.html">Configure nginx and Elasticsearch</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-apache-and-elasticsearch">

            

            
            <a href="/guides/v2.3/config-guide/elasticsearch/es-config-apache.html">Configure Apache and Elasticsearch</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-elasticsearch-stopwords">

            

            
            <a href="/guides/v2.3/config-guide/elasticsearch/es-config-stopwords.html">Configure Elasticsearch stopwords</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-magento-to-use-elasticsearch">

            

            
            <a href="/guides/v2.3/config-guide/elasticsearch/configure-magento.html">Configure Magento to use Elasticsearch</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

		    
		    	

<li class="nav-level1  " id="message-queues">
    

    
    <a href="/guides/v2.3/config-guide/mq/rabbitmq-overview.html">Message Queues</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="manage-message-queues">

            

            
            <a href="/guides/v2.3/config-guide/mq/manage-mysql.html">Manage message queues</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

		    
		    	

<li class="nav-level1  " id="split-database-performance-solution-(magento-commerce-only)">
    

    
    <a href="/guides/v2.3/config-guide/multi-master/multi-master.html">Split database performance solution (Magento Commerce only)</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="automatically-configure-master-databases">

            

            
            <a href="/guides/v2.3/config-guide/multi-master/multi-master_masterdb.html">Automatically configure master databases</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="manually-configure-master-databases">

            

            
            <a href="/guides/v2.3/config-guide/multi-master/multi-master_manual.html">Manually configure master databases</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="verify-split-databases">

            

            
            <a href="/guides/v2.3/config-guide/multi-master/multi-master_verify.html">Verify split databases</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-optional-database-replication">

            

            
            <a href="/guides/v2.3/config-guide/multi-master/multi-master_slavedb.html">Set up optional database replication</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="custom-logging">
    

    
    <a href="/guides/v2.3/config-guide/log/log-intro.html">Custom Logging</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="magento-logging-in-more-detail">

            

            
            <a href="/guides/v2.3/config-guide/log/log-magento.html">Magento logging in more detail</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="example---logging-database-activity">

            

            
            <a href="/guides/v2.3/config-guide/log/log-db.html">Example - logging database activity</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="how-to-locate-your-session-files">
    

    
    <a href="/guides/v2.3/config-guide/sessions.html">How to locate your session files</a>
    

    
</li>


		    
		    	

		    
		    	

		    
		    </ul>
		</div>

	</div>

</aside>
<!-- /sidebar -->


	<section class="content">
		<div class="content-wrap">
			<!-- page-header -->
<section class="page-intro">
	

  <nav class="breadcrumbs">

    <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      <li class="breadcrumb-item"><a class="breadcrumb-item" href="/guides/v2.3/"><span>Home</span></a></li>

    <!-- Iteration breadcrumb item -->
    
    

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">

        
          <a property="item" typeof="WebPage" href="/guides/v2.3/config-guide/bk-config-guide.html">
            <span property="name">Configuration Guide</span>
          </a>
        

        <meta property="position" content="1" />
      </li>

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item active" property="itemListElement" typeof="ListItem">

        

          

          <span property="name">Advanced Varnish configuration</span>

        

        <meta property="position" content="2" />
      </li>

    

    </ol>

  </nav>



	

	

	<h1 class="page-heading">Advanced Varnish configuration</h1>

  


</section>

			<p>Varnish provides several features that prevent customers from experiencing long delays and timeouts when the Magento server is not functioning properly. These features can be configured in the <code class="highlighter-rouge">default.vcl</code> file. This topic describes the additions that Magento provides in the VCL (Varnish Configuration Language) file you download from <span term-uuid="18b930cf-09cc-47c9-a5e5-905f86c43f81" class="glossary-term" data-toggle="popover">Magento Admin</span>.</p>

<p>See the <a href="https://www.varnish-cache.org/docs/4.1/reference/index.html">Varnish Reference Manual</a> for details about using the Varnish Configuration Language.</p>

<h2 id="health">Health check</h2>
<p>Varnish’s health check feature polls the Magento server to determine whether it is responding in a timely manner. If it is responding normally, fresh content will be regenerated after the Time to Live (TTL) period has expired. If not, Varnish always serves stale content.</p>

<p>Magento defines the following default health check:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">.probe</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">.url</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"/pub/health_check.php"</span><span class="err">;</span><span class="w">
    </span><span class="err">.timeout</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">2</span><span class="err">s;</span><span class="w">
    </span><span class="err">.interval</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">5</span><span class="err">s;</span><span class="w">
    </span><span class="err">.window</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">10</span><span class="err">;</span><span class="w">
    </span><span class="err">.threshold</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">5</span><span class="err">;</span><span class="w">
    </span><span class="p">}</span></code></pre></figure>

<p>Every 5 seconds, this health check calls the <code class="highlighter-rouge">pub/health_check.php</code> script. This script checks the availability of the server, each database, and Redis (if installed). The script must return a response within 2 seconds. If the script determines that any of these resources are down, it returns a 500 HTTP error code. If this error code is received in 6 out of 10 attempts, the <span term-uuid="74d6d228-34bd-4475-a6f8-0c0f4d6d0d61" class="glossary-term" data-toggle="popover">backend</span> is considered unhealthy.</p>

<p>The <code class="highlighter-rouge">health_check.php</code> script is located in the <code class="highlighter-rouge">pub</code> directory. If your Magento root directory is <code class="highlighter-rouge">pub</code>, then be sure to change the path in the <code class="highlighter-rouge">url</code> parameter from <code class="highlighter-rouge">/pub/health_check.php</code> to <code class="highlighter-rouge">health_check.php</code>.</p>

<p>For more information, see the <a href="https://varnish-cache.org/docs/4.1/users-guide/vcl-backends.html?highlight=health%20check#health-checks" target="_blank">Varnish health checks</a> documentation.</p>

<h2 id="grace">Grace mode</h2>

<p>Grace mode enables Varnish to keep an object in <span term-uuid="0bc9c8bc-de1a-4a06-9c99-a89a29c30645" class="glossary-term" data-toggle="popover">cache</span> beyond its TTL value. Varnish can then serve the expired (stale) content while it fetches a new version. This improves the flow of traffic and decreases load times. It’s used in the following situations:</p>

<ul>
  <li>When the Magento backend is healthy, but a request is taking longer than normal</li>
  <li>When the Magento backend is not healthy.</li>
</ul>

<p>The <code class="highlighter-rouge">vcl_hit</code> subroutine defines how Varnish responds to a request for objects that have been cached.</p>

<h3 id="grace-healthy">When the Magento backend is healthy</h3>

<p>When the health checks determine that the Magento backend is healthy, Varnish checks whether time remains in the grace period. The default grace period is 300 seconds, but a merchant can set the value from <span term-uuid="29ddb393-ca22-4df9-a8d4-0024d75739b1" class="glossary-term" data-toggle="popover">Admin</span> as described in <a href="/guides/v2.3/config-guide/varnish/config-varnish-magento.html">Configure Magento to use Varnish</a>. If the grace period hasn’t expired, Varnish delivers the stale content, and asynchronously refreshes the object from the Magento server. If the grace period has expired, Varnish serves the stale content and synchronously refreshes the object from the Magento backend.</p>

<p>The maximum amount of time that Varnish serves a stale object is the sum of the grace period (300 seconds by default) and the TTL value (86400 seconds by default).</p>

<p>To change the default grace period from within the <code class="highlighter-rouge">default.vcl</code> file, edit the following line in the <code class="highlighter-rouge">vcl_hit</code> subroutine:</p>

<p><code class="highlighter-rouge">if (obj.ttl + 300s &gt; 0s) {</code></p>

<h3 id="grace-unhealthy">When the Magento backend is not healthy</h3>

<p>If the Magento backend is not responsive, Varnish serves stale content from cache for three days (or as defined in <code class="highlighter-rouge">beresp.grace</code>) plus the remaining TTL (which by default is one day), unless the cached content is manually purged.</p>

<h2 id="saint">Saint mode</h2>

<p>Saint mode blacklists unhealthy backends for a configurable amount of time. As a result, unhealthy backends cannot serve traffic when using Varnish as a load balancer. Saint mode can be used in conjunction with grace mode to allow for complex handling of unhealthy backend servers. For example, if one backend server is unhealthy, retries can be routed to another server. If all other servers are down, then serve stale cached objects. The saint mode backend hosts and blackout periods are defined in the <code class="highlighter-rouge">default.vcl</code> file.</p>

<p>Saint mode can also be used when Magento instances are individually taken offline to perform maintenance and upgrade tasks without affecting the availability of the Magento site.</p>

<h3 id="saint-prereq">Saint mode prerequisites</h3>
<p>You should designate one machine as the primary installation. On this machine, install the main instance of Magento, mySQL database, and Varnish.</p>

<p>On all other machines, the Magento instance must have access the primary machine’s mySQL database. The secondary machines should also have access to the files of the primary Magento instance.</p>

<p>Alternatively, <span term-uuid="363662cb-73f1-4347-a15e-2d2adabeb0c2" class="glossary-term" data-toggle="popover">static files</span> versioning can be turned off on all machines. This can be accessed from the Admin under <strong>Stores &gt; Configuration &gt; Advanced &gt; Developer &gt; Static Files Settings &gt; Sign Static Files</strong> = <strong>No</strong>.</p>

<p>Finally, all Magento instances must be in production mode. Before Varnish starts, clear the cache on each instance. In Admin, go to <strong>System &gt; Cache Management</strong> and click <strong>Flush Magento Cache</strong>. You can also run the following command to clear the cache:</p>

<p><code class="highlighter-rouge">bin/magento cache:flush</code></p>

<h3 id="saint-install">Installation</h3>

<p>Saint mode is not part of the main Varnish package. It is a separately-versioned vmod that must be downloaded and installed. As a result, you should re-compile Varnish from source, as described in the following articles:</p>

<ul>
  <li><a href="https://www.varnish-cache.org/docs/5.0/installation/install.html">Installing Varnish 5.0</a></li>
  <li><a href="https://www.varnish-cache.org/docs/4.1/installation/install.html">Installing Varnish 4.1</a></li>
  <li><a href="https://www.varnish-cache.org/docs/4.0/installation/install.html">Installing Varnish 4.0</a></li>
</ul>

<p>After you’ve recompiled, you can install the Saint mode <span term-uuid="c1e4242b-1f1a-44c3-9d72-1d5b1435e142" class="glossary-term" data-toggle="popover">module</span>. In general, follow these steps:</p>

<ol>
<li><p>Obtain the source code from <a href="https://github.com/varnish/varnish-modules">Varnish modules</a> . Clone the git version (master version) since the 0.9.x versions contain a source code error.</p></li>

<li><p>Build the source code with autotools:</p>

<p><code>sudo apt-get install libvarnishapi-dev || sudo yum install varnish-libs-devel</code></p>
<p><code>./bootstrap   # If running from git.</code></p>
<p><code>./configure</code></p>
<p><code>make</code></p>
<p><code>make check   # optional</code></p>
<p><code>sudo make install</code></p>
</li></ol>

<p>See <a href="https://github.com/varnish/varnish-modules">Varnish module collection</a> for information about installing the Saint mode module.</p>

<h3 id="saint-sample">Sample <code class="highlighter-rouge">vcl</code> file</h3>

<p>The following code example shows the code that must be added to your VCL file to enable saint mode. Place the <code class="highlighter-rouge">import</code> statements and <code class="highlighter-rouge">backend</code> definitions at the top of the file.</p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">import</span> <span class="n">saintmode</span><span class="p">;</span>
<span class="n">import</span> <span class="n">directors</span><span class="p">;</span>

<span class="n">backend</span> <span class="n">default1</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.0.1"</span><span class="p">;</span>
    <span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="s">"8080"</span><span class="p">;</span>
    <span class="p">.</span><span class="n">first_byte_timeout</span> <span class="o">=</span> <span class="mi">600</span><span class="n">s</span><span class="p">;</span>
        <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="s">"/pub/health_check.php"</span><span class="p">;</span>
            <span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="n">s</span><span class="p">;</span>
            <span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">5</span><span class="n">s</span><span class="p">;</span>
            <span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="p">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="n">backend</span> <span class="n">default2</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.0.2"</span><span class="p">;</span>
    <span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="s">"8080"</span><span class="p">;</span>
    <span class="p">.</span><span class="n">first_byte_timeout</span> <span class="o">=</span> <span class="mi">600</span><span class="n">s</span><span class="p">;</span>
    <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="s">"/pub/health_check.php"</span><span class="p">;</span>
        <span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="n">s</span><span class="p">;</span>
        <span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">5</span><span class="n">s</span><span class="p">;</span>
        <span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="p">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">sub</span> <span class="n">vcl_init</span> <span class="p">{</span>
    <span class="cp"># Instantiate sm1, sm2 for backends tile1, tile2
</span>    <span class="cp"># with 10 blacklisted objects as the threshold for marking the
</span>    <span class="cp"># whole backend sick.
</span>    <span class="k">new</span> <span class="n">sm1</span> <span class="o">=</span> <span class="n">saintmode</span><span class="p">.</span><span class="n">saintmode</span><span class="p">(</span><span class="n">default1</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="k">new</span> <span class="n">sm2</span> <span class="o">=</span> <span class="n">saintmode</span><span class="p">.</span><span class="n">saintmode</span><span class="p">(</span><span class="n">default2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="cp"># Add both to a director. Use sm0, sm1 in place of tile1, tile2.
</span>    <span class="cp"># Other director types can be used in place of random.
</span>    <span class="k">new</span> <span class="n">magedirector</span> <span class="o">=</span> <span class="n">directors</span><span class="p">.</span><span class="n">random</span><span class="p">();</span>
    <span class="n">magedirector</span><span class="p">.</span><span class="n">add_backend</span><span class="p">(</span><span class="n">sm1</span><span class="p">.</span><span class="n">backend</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">magedirector</span><span class="p">.</span><span class="n">add_backend</span><span class="p">(</span><span class="n">sm2</span><span class="p">.</span><span class="n">backend</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">sub</span> <span class="n">vcl_backend_fetch</span> <span class="p">{</span>
    <span class="cp"># Get a backend from the director.
</span>    <span class="cp"># When returning a backend, the director will only return backends
</span>    <span class="cp"># saintmode says are healthy.
</span>    <span class="n">set</span> <span class="n">bereq</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">magedirector</span><span class="p">.</span><span class="n">backend</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">sub</span> <span class="n">vcl_backend_response</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">beresp</span><span class="p">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
        <span class="cp"># This marks the backend as sick for this specific
</span>        <span class="cp"># object for the next 20s.
</span>        <span class="n">saintmode</span><span class="p">.</span><span class="n">blacklist</span><span class="p">(</span><span class="mi">20</span><span class="n">s</span><span class="p">);</span>
        <span class="cp"># Retry the request. This will result in a different backend
</span>        <span class="cp"># being used.
</span>        <span class="k">return</span> <span class="p">(</span><span class="n">retry</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h4 id="final-step">Final step</h4>
<p><a href="/guides/v2.3/config-guide/varnish/config-varnish-final.html">Final verification</a></p>

			
		</div>
		<!-- /.content-wrap -->

		<div class="page-info">

    
  
    
    <div class="github-link">
      <a class="improve-page" href="https://github.com/magento/devdocs/blob/develop/guides/v2.3/config-guide/varnish/config-varnish-advanced.md" target="_blank">
        Edit this page on GitHub
      </a>
    </div>
    
  
    
    <div class="new-issue">
      <a href="https://github.com/magento/devdocs/issues/new?title=Feedback on page: /guides/v2.3/config-guide/varnish/config-varnish-advanced.html" target="_blank">Give us feedback</a>
    </div>
    
  
  </div>

	</section>
	<!-- /.content -->

</div> <!-- /.content-container -->


	</div>
	<!-- /.main-container -->
</div>
<!-- /#gl-wrapper -->

<!-- footer-->
<div class="page-footer">
  <div class="container">

    <div class="copyright-links">
      <ul class="nav footer-links">
  <li><a href="/guides/v2.3/contributor-guide/contributing_docs.html">Become a Contributor</a>
  <li><a href="https://magento.github.io/glossary/index.html?audience=developer">Glossary</a></li>
  <li><a href="http://magento.com/legal/terms/privacy/">Privacy Policy</a></li>
  <li><a href="http://magento.com/legal/terms/">Terms of Service</a></li>
  <li><a href="http://magento.com/legal/licensing/">License/Trademark FAQ</a></li>
  <li><a href="/guides/v2.3/release-notes/bk-release-notes.html">Release Notes</a></li>
  <li><a href="/magento-third-party.html">Third-Party Licenses</a></li>
</ul>

    </div>

		<div class="copyright-date">&copy; 2018 Magento. All rights reserved.</div>

  </div>
</div>
<!-- / #footer -->


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="/assets/js/app.min.js"></script>


<script src="/common/js/devdocs.min.js"></script>



<script type="text/javascript">
    (function() {
        var didInit = false;
        function initMunchkin() {
            if(didInit === false) {
                didInit = true;
                Munchkin.init('585-GGD-959', {cookieAnon: false});
            }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
            if (this.readyState == 'complete' || this.readyState == 'loaded') {
                initMunchkin();
            }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>




</body>
</html>
